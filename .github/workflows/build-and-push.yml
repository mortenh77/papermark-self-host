name: Build & Push Papermark

on:
  push:
    branches: ["main", "master"]
  schedule:
    - cron: "15 5 * * */3" # At 05:15 on every 3rd day-of-week
  workflow_dispatch: {}

env:
  REGISTRY: ${{ secrets.REGISTRY || 'ghcr.io' }} # e.g. ghcr.io
  REGISTRY_IP: ${{ secrets.REGISTRY_IP }} # optional: pin host->IP through WG
  IMAGE_PREFIX: ${{ secrets.IMAGE_PREFIX || 'ghcr.io/mortenh77' }} # e.g. ghcr.io/avnox-com
  PAPERMARK_REPO: mfts/papermark
  PAPERMARK_REF: main
  PAPERMARK_PRS: "" # e.g. "123,456" (leave empty to skip)
  WORKFLOW_TARGET_DIR: "." # no trailing slash
  USE_WG: ${{ secrets.WG_CONF != '' }}

# Permissions required for pushing to ghcr.io
permissions:
  contents: read
  packages: write

jobs:
  build:
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout (this repo)
        uses: actions/checkout@v4

      - name: Checkout Papermark upstream
        uses: actions/checkout@v4
        with:
          repository: ${{ env.PAPERMARK_REPO }}
          ref: ${{ env.PAPERMARK_REF }}
          path: ${{ env.WORKFLOW_TARGET_DIR }}/papermark-src
          fetch-depth: 0 # IMPORTANT: we need history to merge PRs

      - name: Apply selected PRs onto Papermark
        if: ${{ env.PAPERMARK_PRS != '' }}
        working-directory: ${{ env.WORKFLOW_TARGET_DIR }}/papermark-src
        run: |
          set -euo pipefail
          IFS=',' read -ra PRS <<< "${PAPERMARK_PRS}"
          git config user.email "ci@github"
          git config user.name "GitHub Actions"
          for PR in "${PRS[@]}"; do
            echo "==> Fetching PR #${PR}"
            git fetch origin "pull/${PR}/head:pr-${PR}"
            git merge --no-ff --no-edit "pr-${PR}"
          done
          echo "==> Resulting HEAD:"
          git --no-pager log --oneline -n 5

      - name: Apply self-hosting patches
        working-directory: ${{ env.WORKFLOW_TARGET_DIR }}
        run: |
          echo "==> Applying self-hosting patches to papermark-src"
          # Copy patches if they exist (excluding README files)
          if [ -d "patches" ]; then
            echo "Found patches directory, copying files..."
            find patches -type f ! -name "README*.md" -exec sh -c 'cp -v "$1" "papermark-src/$(basename "$1")"' _ {} \;
            echo "✅ Patches applied"
          else
            echo "No patches directory found, skipping..."
          fi
          # Copy custom config files if they exist
          if [ -f "next.config.docker.js" ]; then
            echo "Copying next.config.docker.js..."
            cp -v next.config.docker.js papermark-src/
          fi
          if [ -f "health-endpoint.ts" ]; then
            echo "Copying health-endpoint.ts..."
            cp -v health-endpoint.ts papermark-src/
          fi

      - name: Set short SHA
        id: vars
        run: echo "sha=${GITHUB_SHA::12}" >> $GITHUB_OUTPUT

      - name: Docker setup QEMU
        uses: docker/setup-qemu-action@v3

      - name: Docker setup Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: network=host

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      # -------- Build Papermark application --------
      - name: Build Papermark
        uses: docker/build-push-action@v6
        with:
          context: ${{ env.WORKFLOW_TARGET_DIR }}/papermark-src
          file: ${{ env.WORKFLOW_TARGET_DIR }}/Dockerfile.papermark
          platforms: linux/arm64
          push: true
          load: false
          tags: |
            ${{ env.IMAGE_PREFIX }}/papermark:sha-${{ steps.vars.outputs.sha }}
            ${{ env.IMAGE_PREFIX }}/papermark:latest
          provenance: false
          sbom: false
          build-args: |
            BUILDKIT_INLINE_CACHE=1
            NODE_VERSION=20
            OPENAI_API_KEY=sk-test12345
          cache-from: type=gha,scope=papermark-app-n20
          cache-to: type=gha,mode=max,scope=papermark-app-n20

      - name: Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ **Papermark built successfully**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: \`${IMAGE_PREFIX}/papermark:latest\`" >> $GITHUB_STEP_SUMMARY
          echo "- **SHA Tag**: \`${IMAGE_PREFIX}/papermark:sha-${{ steps.vars.outputs.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Source**: \`${PAPERMARK_REPO}@${PAPERMARK_REF}\`" >> $GITHUB_STEP_SUMMARY
          if [ -n "${PAPERMARK_PRS}" ]; then
            echo "- **PRs Applied**: ${PAPERMARK_PRS}" >> $GITHUB_STEP_SUMMARY
          fi
